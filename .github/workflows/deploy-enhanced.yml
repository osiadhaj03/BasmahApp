# ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub Actions Ø§Ù„Ù…Ø­Ø³Ù†Ø©

name: ğŸš€ Deploy to Hostinger

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'DEPLOYMENT_GUIDE.md'
      - '*.md'
  workflow_dispatch: # ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

env:
  DEPLOY_PATH: /home/u994369532/basmah
  PUBLIC_PATH: /home/u994369532/public_html

jobs:
  deploy:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“‹ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Check for Laravel Project
      run: |
        if [ ! -f "artisan" ]; then
          echo "âŒ This is not a Laravel project!"
          exit 1
        fi
        echo "âœ… Laravel project detected"
    
    - name: ğŸš€ Deploy to Hostinger
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 46.202.156.118
        username: u994369532
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        port: 65002
        timeout: 300s
        script_stop: true
        script: |
          set -e  # Exit on any error
          
          echo "ğŸ¯ Starting deployment for commit: $GITHUB_SHA"
          echo "ğŸ“… Deployment time: $(date)"
          
          # Ø¥Ù†Ø´Ø§Ø¡ backup Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
          echo "ğŸ’¾ Creating backup..."
          BACKUP_DIR="$HOME/backups"
          mkdir -p $BACKUP_DIR
          BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).tar.gz"
          tar -czf "$BACKUP_DIR/$BACKUP_FILE" -C $HOME basmah public_html || echo "âš ï¸ Backup failed, continuing..."
          
          # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          cd ${{ env.DEPLOY_PATH }}
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Git
          echo "ğŸ“¥ Fetching latest changes..."
          git fetch origin main
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse origin/main)
          
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "â„¹ï¸ No new changes detected"
            exit 0
          fi
          
          echo "ğŸ”„ New changes detected, updating..."
          
          # ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©
          echo "ğŸ› ï¸ Enabling maintenance mode..."
          php artisan down --message="Ù†Ø¸Ø§Ù… Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«ØŒ Ø³Ù†Ø¹ÙˆØ¯ Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚" --retry=60 || echo "âš ï¸ Could not enable maintenance mode"
          
          # Ø³Ø­Ø¨ Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
          echo "ğŸ“¦ Pulling latest code..."
          git reset --hard origin/main
          
          # ØªØ­Ø¯ÙŠØ« Composer dependencies
          echo "ğŸ“š Updating dependencies..."
          composer install --no-dev --optimize-autoloader --no-interaction --quiet
          
          # ØªØ´ØºÙŠÙ„ migrations
          echo "ğŸ—ƒï¸ Running database migrations..."
          php artisan migrate --force --no-interaction
          
          # Ù…Ø³Ø­ Ø§Ù„Ù€ cache
          echo "ğŸ§¹ Clearing caches..."
          php artisan config:clear
          php artisan view:clear
          php artisan route:clear
          php artisan cache:clear
          
          # Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ cache Ù„Ù„Ø¥Ù†ØªØ§Ø¬
          echo "âš¡ Building production cache..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ public
          echo "ğŸ“ Syncing public files..."
          rsync -av --delete --exclude=".htaccess" ${{ env.DEPLOY_PATH }}/public/ ${{ env.PUBLIC_PATH }}/
          
          # Ø¥Ù†Ø´Ø§Ø¡ symbolic link Ù„Ù„Ù€ storage
          echo "ğŸ”— Creating storage link..."
          php artisan storage:link || echo "âš ï¸ Storage link already exists"
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù€ permissions
          echo "ğŸ” Setting permissions..."
          find ${{ env.DEPLOY_PATH }}/storage -type f -exec chmod 644 {} \;
          find ${{ env.DEPLOY_PATH }}/storage -type d -exec chmod 755 {} \;
          find ${{ env.DEPLOY_PATH }}/bootstrap/cache -type f -exec chmod 644 {} \;
          find ${{ env.DEPLOY_PATH }}/bootstrap/cache -type d -exec chmod 755 {} \;
          
          # Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Laravel
          echo "ğŸ§ª Testing Laravel..."
          php artisan --version
          
          # Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©
          echo "âœ… Disabling maintenance mode..."
          php artisan up
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š Final commit: $(git log -1 --pretty=format:'%h - %s (%an)')"
          echo "â° Deployment finished at: $(date)"
          
          # ØªÙ†Ø¸ÙŠÙ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ backup Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 5)
          cd $BACKUP_DIR
          ls -t backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f || echo "â„¹ï¸ No old backups to clean"

  # Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
  notify-success:
    name: ğŸ“¢ Notify Success
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    steps:
    - name: ğŸ‰ Success Notification
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "ğŸŒ Website: https://anwaralolmaa.com"
        echo "ğŸ“Š Commit: $GITHUB_SHA"
        echo "ğŸ‘¨â€ğŸ’» Author: $GITHUB_ACTOR"

  # Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„  
  notify-failure:
    name: ğŸ“¢ Notify Failure
    needs: deploy
    runs-on: ubuntu-latest
    if: failure()
    steps:
    - name: âŒ Failure Notification
      run: |
        echo "âŒ Deployment failed!"
        echo "ğŸ” Check the logs above for details"
        echo "ğŸ’¡ The website should still be working with the previous version"
